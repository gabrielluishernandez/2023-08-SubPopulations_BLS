```{r echo=FALSE,  message=FALSE, warning=FALSE}
library(tidyverse)
library(gridExtra)
library(ggsignif)
library(ggpointdensity)
library(ggpubr)
library(ggrepel)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Load data, rename and merge the populations in a single data frame

pop1_genes <- read.table('input/2023-08-04-ranked_by_dens-POP-1.txt', 
                         header = TRUE)
pop1_genes <- pop1_genes[, c("gene", "clr", "ncd05")]
names(pop1_genes) <- c("gene", "clr_pop1", "ncd05_pop1")

pop2_genes <- read.table('input/2023-08-04-ranked_by_dens-POP-2.txt', 
                         header = TRUE)
pop2_genes <- pop2_genes[, c("gene", "clr", "ncd05")]
names(pop2_genes) <- c("gene", "clr_pop2", "ncd05_pop2")

pop3_genes <- read.table('input/2023-08-04-ranked_by_dens-POP-3.txt', 
                         header = TRUE)
pop3_genes <- pop3_genes[, c("gene", "clr", "ncd05")]
names(pop3_genes) <- c("gene", "clr_pop3", "ncd05_pop3")

pop4_genes <- read.table('input/2023-08-04-ranked_by_dens-POP-4.txt', 
                         header = TRUE)
pop4_genes <- pop4_genes[, c("gene", "clr", "ncd05")]
names(pop4_genes) <- c("gene", "clr_pop4", "ncd05_pop4")

merged_pops <- merge(
  merge(
    merge(
      pop1_genes, pop2_genes, by = "gene"), 
    pop3_genes, by = "gene"), 
  pop4_genes, by = "gene"
  )

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Standardize data 

gene_names <- merged_pops$gene
standardized_data <- scale(merged_pops[, -1])

# Perform PCA
pca_result <- prcomp(standardized_data, center = TRUE, scale. = TRUE)

# Create a data frame with PCA scores
pca_scores <- as.data.frame(pca_result$x)
colnames(pca_scores) <- c("PC1", "PC2")  # Rename columns

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Add gene names back
pca_results_with_names <- data.frame(
  gene = gene_names,
  PC1 = pca_scores$PC1,
  PC2 = pca_scores$PC2
)

#get the master table
bias_and_all <- read.table('input/2023_08_22_MASTER_cleaned_all_pops.txt',
                             header = TRUE) 


bias_and_all <- merge(bias_and_all, pca_results_with_names, by = "gene")
bias_and_all$candens <- as.factor(bias_and_all$candens)
bias_and_all$hymenop <- as.factor(bias_and_all$hymenop)
bias_and_all$pop1 <- as.factor(bias_and_all$pop1)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(bias_and_all %>% arrange(candens)
       , aes(x = PC1, y = PC2, colour = candens, shape = candens)) +
  geom_point(size = 4, alpha = 0.6) +
  scale_colour_viridis_d(option = "D", direction = 1)+ # , name = "Immune", labels = c("No","Yes"))
  #geom_text(hjust = 0, vjust = 0) +
  labs(x = "PC1", y = "PC2")+
  theme_minimal()

```



```{r echo=FALSE, message=FALSE, warning=FALSE}

strong_genes <- subset(bias_and_all, candens == "1") %>% subset(PC1 >= 5) %>% 
  arrange(desc(PC1))

bias_and_all$names <- NA


for(i in 1:nrow(bias_and_all)) {                     
  if(is.na(bias_and_all$clr[i])){
    next
  }
  if(bias_and_all$gene[i] == "LOC105207562"){
    bias_and_all$names[i]  <- "Agrin"
  }
}


```


```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(bias_and_all %>% arrange(candens)
       , aes(x = PC1, y = PC2, colour = candens, shape = names)) +
  geom_point(size = 4, alpha = 0.6) +
  scale_colour_viridis_d(option = "D", direction = 1)+ # , name = "Immune", labels = c("No","Yes"))
  #geom_text(hjust = 0, vjust = 0) +
  labs(x = "PC1", y = "PC2")+
  theme_minimal()

```
